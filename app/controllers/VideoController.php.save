<?php
/**
 * Video Controller
 * Handles home, watch, upload
 */

class VideoController extends Controller
{
    /**
     * Home page â€“ list latest videos
     */
    public function index(): void
    {
        $videos = Video::latest(20);

        $this->view('home', [
            'videos' => $videos
        ]);
    }

    /**
     * Watch video page
     */
    public function watch(): void
    {
        $id = (int) ($_GET['id'] ?? 0);

        if ($id <= 0) {
            http_response_code(404);
            exit('Video not found');
        }

        $video = Video::find($id);

        if (!$video) {
            http_response_code(404);
            exit('Video not found');
        }

        // Increase views
        Video::incrementViews($id);

        $likes    = Like::count($id, 'like');
        $dislikes = Like::count($id, 'dislike');
	$comments = Comment::treeForVideo($id);
        $this->view('watch', [
            'video'    => $video,
            'likes'    => $likes,
            'dislikes' => $dislikes,
            'comments' => $comments,
            'csrf'     => CSRF::generate()
        ]);
    }

    /**
     * Upload form
     */
    public function uploadForm(): void
    {
        if (!Auth::check()) {
            $this->redirect('login');
        }

        $this->view('upload', [
            'csrf' => CSRF::generate()
        ]);
    }

    /**
     * Handle video upload
     */
    public function upload(): void
    {
        if (!Auth::check()) {
            http_response_code(403);
            exit('Unauthorized');
        }

        if (!CSRF::validate($_POST['_csrf'] ?? null)) {
            http_response_code(403);
            exit('Invalid CSRF token');
        }

        if (!isset($_FILES['video']) || $_FILES['video']['error'] !== UPLOAD_ERR_OK) {
            exit('Upload failed');
        }

        $config = App::$config['upload'];

        if ($_FILES['video']['size'] > $config['max_video_size']) {
            exit('File too large');
        }

        if ($_FILES['video']['type'] !== 'video/mp4') {
            exit('Only MP4 allowed');
        }

        $filename = uniqid('video_', true) . '.mp4';
        $target   = App::$config['paths']['uploads'] . '/videos/' . $filename;

        if (!move_uploaded_file($_FILES['video']['tmp_name'], $target)) {
            exit('Failed to save file');
        }

        Video::create([
            'user_id'     => Auth::user()['id'],
            'title'       => trim($_POST['title']),
            'description' => trim($_POST['description']),
            'filename'    => $filename
        ]);

        CSRF::destroy();
        $this->redirect('');
    }
    /**
     * Delete video
     */
    public function delete(): void
    {
        if (!Auth::check()) {
            http_response_code(403);
            exit('Unauthorized');
        }

        $videoId = (int) ($_GET['id'] ?? 0);

        if ($videoId <= 0) {
            exit('Invalid video');
        }

        $video = Video::find($videoId);

        if (!$video) {
            exit('Video not found');
        }

        $user = Auth::user();

        // Permission check:
        // Owner OR Admin OR Video owner
        if (
            !Auth::isOwner() &&
            !Auth::isAdmin() &&
            $video['user_id'] !== $user['id']
        ) {
            http_response_code(403);
            exit('Permission denied');
        }

        Video::delete($videoId);

        $this->redirect('');
    }
    /**
     * Upload form
     */
            http_response_code(403);
            exit('Unauthorized');
        }

        if (!CSRF::validate($_POST['_csrf'] ?? null)) {
            exit('Invalid CSRF token');
        }

        $title = trim($_POST['title'] ?? '');
        $description = trim($_POST['description'] ?? '');

        if ($title === '' || empty($_FILES['video']['name'])) {
            exit('Invalid input');
        }

        // Validate video
        $ext = strtolower(pathinfo($_FILES['video']['name'], PATHINFO_EXTENSION));
        if ($ext !== 'mp4') {
            exit('Only MP4 allowed');
        }

        $filename = uniqid('video_') . '.mp4';
        $target = App::$config['paths']['uploads'] . '/videos/' . $filename;

        if (!move_uploaded_file($_FILES['video']['tmp_name'], $target)) {
            exit('Upload failed');
        }

        // Save to DB
        Video::create([
            'user_id'     => Auth::user()['id'],
            'title'       => $title,
            'description' => htmlspecialchars($description, ENT_QUOTES, 'UTF-8'),
            'filename'    => $filename
        ]);

        CSRF::destroy();
        $this->redirect('');
    }

}
